<!DOCTYPE html>
<html>
<head>
    <title>Lab 11 Setup Demo</title>
    <meta charset="utf-8" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
        table td, table th {
            border: 1px solid black
        }

        table {
            border-collapse: collapse
        }
    </style>
</head>

<body>

    <main id="contactPage">

        <form>
            Firstname:<input id="firstname" name="firstname" type="text" required /><br />
            Address:<input id="address" name="address" type="text" required /><br />
            Email:<input id="email" name="email" type="email" required /><br />
            <input id="SubmitButton" type="submit" value="submit" />
        </form>

        <br /><br />

        <table>
            <thead>
                <tr>
                    <th>Contact name</th>
                    <th>Phone number</th>
                    <th>Email address</th>
                    <th><a class="deleteAll" href="#">Delete All</a></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>



    </main>

    <script>
        $(document).ready(function () {

            var mainElement = document.getElementById('contactPage');

            loadContacts();  // (declared below) loads and displays existing data

            function loadContacts() {
                var contactsStored = localStorage.getItem('contacts');

                if (contactsStored) { // check if we have any stored data 

                    // if we have data (in JSON) , then parse back into an array of data objects = "records"
                    var contacts = JSON.parse(contactsStored);

                    // loop through all the array elements of the contacts array ...
                    // and then execute a function on each element
                    $.each(contacts, function (index, contact) {
                        // contacts[index] or contact gives the current array element
                        // for each element, build an html row
                        var row = $('<tr>'); // creates a new html tr or row element

                        // create the inner html for the row: 4 cols (td's)
                        // containing the column values from each property of the current array element
                        // notice the delete link will need to have click event attached later 
                        var html = '<td>' + contact.firstname + '</td>' +
                            '<td>' + contact.address + '</td>' +
                            '<td>' + contact.email + '</td>' +
                            '<td><a class="delete" href="#">delete</a></td>';

                        // tag the new row with the id for the contact record object
                        row.data().contactId = contact.id;

                        // put the html inside the row
                        row.append(html);
                        // now add the row to the table at teh end of the tbody
                        $(mainElement).find('table tbody').append(row);
                    });
                }
            }

            // same as Lab 10
            function serializeForm() {
                var inputFields = $(mainElement).find('form :input');
                var result = {};
                $.each(inputFields, function (index, value) {
                    if ($(value).attr('name')) {
                        result[$(value).attr('name')] = $(value).val();
                    }
                });
                return result;
            }

            function store(contact) {
                // get anything stored under the key "contacts" as JSON data
                var contactsStored = localStorage.getItem('contacts'); // JSON String

                var contacts = []; // declare a new, empty array

                if (contactsStored) { // check if there is something stored
                    contacts = JSON.parse(contactsStored); // then parse / convert it to an array
                }
                contacts.push(contact); // add our new contact at the end of the array

                // overwrite the local storage with the new array
                localStorage.setItem('contacts', JSON.stringify(contacts));
            }

            function saveContact() {
                // get the for data into a data object
                var contact = serializeForm(); // create one property for form input: firstname, email , address

                // create a unique identifier (primary key) for the new contact record
                // as an id property
                contact.id = $.now(); // use the system clock to get a number (# milliseconds since 1970/01/01)

                var row = $('<tr>'); // create a row object
                // load the row object with the contact object data
                var html = '<td>' + contact.firstname + '</td>' +
                    '<td>' + contact.address + '</td>' +
                    '<td>' + contact.email + '</td>' +
                    '<td><a class="delete" href="#">delete</a></td>';

                // tag the new row with the id for the contact record object
                row.data().contactId = contact.id;

                // add the new td's to the row
                row.append(html);

                // store the new contact object in local storage
                store(contact);

                 // attach the new row to the table
               $(mainElement).find('table tbody').append(row);
                $(mainElement).find('form :input[name]').val(''); // clear form for reuse
            }

            function deleteContact(evt) {
                // retrieve the unique id of the record / row whose delete link link was clicked
                // evt.target = clicked link
                // .parents() -> selects all the parents of the link
                // .parents('tr') -> selects the immediate tr parent of the link
                // .data().contactId -> references the tagged data under the key 'contactId'
                var contactId = $(evt.target).parents('tr').data().contactId;

                // retrieve the contacts array from local storage
                var contacts = JSON.parse(localStorage.getItem('contacts'));

                // "filter out" all (only one) the elements from the array that match the element 
                // with the id to delete
                // filter returns all the elements that make the function return true
                // implicit loop: run the function on each element in contacts array
                var newContacts = contacts.filter(function (c) {
                    // c = current element
                    // return true if the element is NOT to be deleted (i.e. keep this element)
                    // when done, the element with id == contactId will be omnitted
                    return c.id != contactId; 
                });
                // now newContacts is a copy of the local storage array, with one element removed

                // overwrite local storage with this new array
                localStorage.setItem('contacts', JSON.stringify(newContacts));

                // also remove the row from the table
                $(evt.target).parents('tr').remove();
            }

            $(mainElement).find("a.deleteAll").click(
                function (evt) {
                    evt.preventDefault(); // surpress default link click behaviour
                    localStorage.clear(); // empty the entire local storage for this page
                    $(mainElement).find('table tbody').empty(); // delete the displayted rows from the table
                }
            );

            $(mainElement).on("click", "a.delete",
                function (evt) {
                    evt.preventDefault(); // surpress default link click behaviour
                    deleteContact(evt); // delete the current row / item
                }
            );

            $(mainElement).find('form input[type="submit"]').click(
                function (evt) {
                    // on submit button click ...

                    // stop the default behaviour of the submit 
                    evt.preventDefault(); // stop form submit
                    saveContact(); // process and save the form data
                });



        });
    </script>


</body>
</html>